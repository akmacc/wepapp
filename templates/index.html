{% extends "base.html" %}
{% block title %}Live Monitor Dashboard{% endblock %}

{% block content %}
<div id="monitor-section" class="dashboard-section active-section">
  <h2 class="section-title">Live System Monitoring</h2>
  <div class="dashboard-grid monitor-grid">
    <section class="dashboard-card">
      <div class="card-header"><i class="fas fa-microchip"></i> <h3>CPU Usage</h3></div>
      <div class="card-body">
        <canvas id="cpuChart"></canvas>
        <div class="stat-live" id="cpuValue">--%</div>
      </div>
    </section>
    <section class="dashboard-card">
      <div class="card-header"><i class="fas fa-memory"></i> <h3>RAM Usage</h3></div>
      <div class="card-body">
        <canvas id="ramChart"></canvas>
        <div class="stat-live" id="ramValue">--%</div>
      </div>
    </section>
    <section class="dashboard-card">
      <div class="card-header"><i class="fas fa-hdd"></i> <h3>Storage Usage</h3></div>
      <div class="card-body">
        <canvas id="mountPieChart"></canvas>
        <div class="stat-live" id="mountValue">--%</div>
        <div class="mount-select-row">
          <select id="mountSelect" class="form-select" onchange="changeMount()"></select>
        </div>
      </div>
    </section>
    <section class="dashboard-card">
      <div class="card-header"><i class="fas fa-chart-line"></i> <h3>Disk I/O Rate (MB/s)</h3></div>
      <div class="card-body">
        <canvas id="diskIOChart"></canvas>
        <div class="stat-live small-text" id="diskIOValue">Read: -- / Write: --</div>
      </div>
    </section>
    <section class="dashboard-card">
      <div class="card-header"><i class="fas fa-network-wired"></i> <h3>Network I/O Rate (MB/s)</h3></div>
      <div class="card-body">
        <canvas id="netIOChart"></canvas>
        <div class="stat-live small-text" id="netIOValue">Sent: -- / Recv: --</div>
      </div>
    </section>
  </div>
</div>

<div id="live-report-section" class="dashboard-section">
  <h2 class="section-title">On-Demand Reports</h2>
  <!-- Oracle Connection Details Input - REMOVED -->

  <div class="reports-grid">
    <article class="report-card" id="tablespace-card">
      <div class="card-header"><i class="fas fa-database"></i> <h4>Tablespace Monitor</h4></div>
      <div class="card-body">
        <div class="button-group">
          <button class="action-btn run-btn" data-report-type="tablespace" data-report-display-name="Tablespace Report" onclick="runTablespaceReport()">
            <i class="fas fa-play"></i> Run
          </button>
          <button class="action-btn view-btn" data-report-type="tablespace" data-report-display-name="Tablespace Report" onclick="handleLiveReportAction(this, 'view')" disabled>
            <i class="fas fa-eye"></i> View
          </button>
          <button class="action-btn download-btn" data-report-type="tablespace" data-report-display-name="Tablespace Report" onclick="handleLiveReportAction(this, 'download')" disabled>
            <i class="fas fa-download"></i> Download
          </button>
        </div>
        <div class="last-update" id="tablespace-last-update"><i class="far fa-clock"></i> Last update: Not run yet</div>
      </div>
    </article>
    <article class="report-card" id="invalid-objects-card">
      <div class="card-header"><i class="fas fa-exclamation-triangle"></i> <h4>Invalid Objects</h4></div>
      <div class="card-body">
        <div class="button-group">
          <button class="action-btn run-btn" data-report-type="invalid-objects" data-report-display-name="Invalid Objects Report" onclick="runInvalidObjectsReport()">
            <i class="fas fa-play"></i> Run
          </button>
          <button class="action-btn view-btn" data-report-type="invalid-objects" data-report-display-name="Invalid Objects Report" onclick="handleLiveReportAction(this, 'view')" disabled>
            <i class="fas fa-eye"></i> View</button>
          <button class="action-btn download-btn" data-report-type="invalid-objects" data-report-display-name="Invalid Objects Report" onclick="handleLiveReportAction(this, 'download')" disabled>
            <i class="fas fa-download"></i> Download</button>
        </div>
        <div class="last-update" id="invalid-objects-last-update"><i class="far fa-clock"></i> Last update: Not run yet</div>
      </div>
    </article>

    <!-- NEW LIVE REPORT CARDS -->
    <article class="report-card" id="concurrent-managers-card">
      <div class="card-header"><i class="fas fa-tasks"></i> <h4>Concurrent Managers</h4></div>
      <div class="card-body">
        <div class="button-group">
          <button class="action-btn run-btn" data-report-type="concurrent-managers" data-report-display-name="Concurrent Managers Report" onclick="runConcurrentManagersReport()">
            <i class="fas fa-play"></i> Run
          </button>
          <button class="action-btn view-btn" data-report-type="concurrent-managers" data-report-display-name="Concurrent Managers Report" onclick="handleLiveReportAction(this, 'view')" disabled>
            <i class="fas fa-eye"></i> View
          </button>
          <button class="action-btn download-btn" data-report-type="concurrent-managers" data-report-display-name="Concurrent Managers Report" onclick="handleLiveReportAction(this, 'download')" disabled>
            <i class="fas fa-download"></i> Download
          </button>
        </div>
        <div class="last-update" id="concurrent-managers-last-update"><i class="far fa-clock"></i> Last update: Not run yet</div>
      </div>
    </article>

    <article class="report-card" id="workflow-mailer-card">
      <div class="card-header"><i class="fas fa-envelope"></i> <h4>Workflow Mailer Status</h4></div>
      <div class="card-body">
        <div class="button-group">
          <button class="action-btn run-btn" data-report-type="workflow-mailer" data-report-display-name="Workflow Mailer Report" onclick="runWorkflowMailerReport()">
            <i class="fas fa-play"></i> Run
          </button>
          <button class="action-btn view-btn" data-report-type="workflow-mailer" data-report-display-name="Workflow Mailer Report" onclick="handleLiveReportAction(this, 'view')" disabled>
            <i class="fas fa-eye"></i> View
          </button>
          <button class="action-btn download-btn" data-report-type="workflow-mailer" data-report-display-name="Workflow Mailer Report" onclick="handleLiveReportAction(this, 'download')" disabled>
            <i class="fas fa-download"></i> Download
          </button>
        </div>
        <div class="last-update" id="workflow-mailer-last-update"><i class="far fa-clock"></i> Last update: Not run yet</div>
      </div>
    </article>
    
    <article class="report-card" id="top-segments-card">
      <div class="card-header"><i class="fas fa-chart-pie"></i> <h4>Top 10 Largest Segments</h4></div>
      <div class="card-body">
        <div class="button-group">
          <button class="action-btn run-btn" data-report-type="top-segments" data-report-display-name="Top Segments Report" onclick="runTopSegmentsReport()">
            <i class="fas fa-play"></i> Run
          </button>
          <button class="action-btn view-btn" data-report-type="top-segments" data-report-display-name="Top Segments Report" onclick="handleLiveReportAction(this, 'view')" disabled>
            <i class="fas fa-eye"></i> View
          </button>
          <button class="action-btn download-btn" data-report-type="top-segments" data-report-display-name="Top Segments Report" onclick="handleLiveReportAction(this, 'download')" disabled>
            <i class="fas fa-download"></i> Download
          </button>
        </div>
        <div class="last-update" id="top-segments-last-update"><i class="far fa-clock"></i> Last update: Not run yet</div>
      </div>
    </article>

    <article class="report-card" id="concurrent-history-card">
      <div class="card-header"><i class="fas fa-history"></i> <h4>Concurrent History</h4></div>
      <div class="card-body">
        <div class="button-group">
          <button class="action-btn run-btn" data-report-type="concurrent-history" data-report-display-name="Concurrent History Report" onclick="runConcurrentHistoryReport()">
            <i class="fas fa-play"></i> Run
          </button>
          <button class="action-btn view-btn" data-report-type="concurrent-history" data-report-display-name="Concurrent History Report" onclick="handleLiveReportAction(this, 'view')" disabled>
            <i class="fas fa-eye"></i> View
          </button>
          <button class="action-btn download-btn" data-report-type="concurrent-history" data-report-display-name="Concurrent History Report" onclick="handleLiveReportAction(this, 'download')" disabled>
            <i class="fas fa-download"></i> Download
          </button>
        </div>
        <div class="last-update" id="concurrent-history-last-update"><i class="far fa-clock"></i> Last update: Not run yet</div>
      </div>
    </article>

    <article class="report-card" id="database-backup-card">
      <div class="card-header"><i class="fas fa-save"></i> <h4>Database Backup Status</h4></div>
      <div class="card-body">
        <div class="button-group">
          <button class="action-btn run-btn" data-report-type="database-backup" data-report-display-name="Database Backup Report" onclick="runDatabaseBackupReport()">
            <i class="fas fa-play"></i> Run
          </button>
          <button class="action-btn view-btn" data-report-type="database-backup" data-report-display-name="Database Backup Report" onclick="handleLiveReportAction(this, 'view')" disabled>
            <i class="fas fa-eye"></i> View
          </button>
          <button class="action-btn download-btn" data-report-type="database-backup" data-report-display-name="Database Backup Report" onclick="handleLiveReportAction(this, 'download')" disabled>
            <i class="fas fa-download"></i> Download
          </button>
        </div>
        <div class="last-update" id="database-backup-last-update"><i class="far fa-clock"></i> Last update: Not run yet</div>
      </div>
    </article>
    <!-- END NEW LIVE REPORT CARDS -->

  </div>
</div>

<div id="reports-section" class="dashboard-section">
  <h2 class="section-title">Pre-generated Reports</h2>
  <div class="reports-grid">
    {% for name, file in reports.items() %}
    <article class="report-card">
      <div class="card-header"><i class="fas fa-chart-bar"></i> <h4>{{ name }}</h4></div>
      <div class="card-body">
        {% if file %}
        <div class="button-group">
            <button class="action-btn view-btn" onclick="openModal('{{ file.filename }}', '{{ name }}')"><i class="fas fa-eye"></i> View</button>
            <button class="action-btn download-btn" onclick="downloadReport('{{ file.filename }}')"><i class="fas fa-download"></i> Download</button>
        </div>
        <div class="last-update"><i class="far fa-clock"></i> Last update: {{ file.last_modified }}</div>
        {% else %}
        <p class="not-found">Report not found</p>
        {% endif %}
      </div>
    </article>
    {% endfor %}
  </div>
</div>

<div id="modal-overlay" onclick="closeModal(event)">
  <div id="modal-window" onclick="event.stopPropagation()">
    <div id="modal-header">
      <span id="modal-title">Report Viewer</span>
      <button id="modal-close-btn" onclick="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <iframe id="modal-iframe"></iframe>
  </div>
</div>

<script>
  // This global variable will be populated by the Flask backend
  window.live_reports_initial_state = {{ live_reports_initial_state | tojson }};
</script>
{% endblock %}
